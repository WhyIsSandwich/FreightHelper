import{_ as P,c as r,a as t,t as u,g as z,b as _,w as m,v as j,d as w,e as H,s as K,n as W,F as p,f as x,i as X,u as Y,m as h,l as C,o as Z,p as $,A as tt,q as d}from"./main-B_gwUFM9.js";const et={name:"JobForm",setup(){const q=X(),e=Y(),k=new tt,o=h(()=>q.params.orderId),f=h(()=>q.params.jobId),v=h(()=>!!f.value),n=h(()=>{const i={};return b.value.forEach(a=>{i[a.commodity_type]||(i[a.commodity_type]=[]),i[a.commodity_type].push(a)}),i}),c=h(()=>{const i={};return b.value.forEach(a=>{i[a.site_name]||(i[a.site_name]=[]),i[a.site_name].push(a)}),i}),s=C({external_job_id:"",job_type:"contractor",contractor_fleet_carrier:"",subcontractor_jobId:"",job_cost:0,due_date:"",commodities:[]}),b=C([]),A=C(!1),S=C(null),D=C(!1),E=C("commodity"),I=C(!1),F=async()=>{var i;if(v.value)try{A.value=!0,S.value=null;const a=await k.db.jobs.where("job_id").equals(f.value).first();if(!a)throw new Error(`Job with ID ${f.value} not found`);s.value={external_job_id:a.external_job_id||"",job_type:a.job_type||"contractor",contractor_fleet_carrier:a.contractor_fleet_carrier||"",subcontractor_jobId:a.subcontractor_jobId||"",job_cost:a.job_cost||0,due_date:a.due_date||"",commodities:((i=a.commodities)==null?void 0:i.map(l=>({commodity_type:l.commodity_type,quantity:l.quantity,site_id:l.site_id})))||[]}}catch(a){console.error("Error loading job data:",a),S.value=a.message}finally{A.value=!1}},J=async()=>{try{b.value=await k.getAvailableCommodities(o.value)}catch(i){console.error("Error loading available commodities:",i)}};Z(()=>s.value.commodities,i=>{i.forEach(a=>{(a.quantity<=0||isNaN(a.quantity))&&(a.quantity=1),a.quantity&&!Number.isInteger(a.quantity)&&(a.quantity=Math.floor(a.quantity))})},{deep:!0}),$(async()=>{await J(),v.value&&await F()});const B=i=>{i.available_quantity>0&&s.value.commodities.push({commodity_type:i.commodity_type,quantity:i.available_quantity,site_id:i.site_id})},V=i=>{s.value.commodities.splice(i,1)},M=()=>{s.value.commodities.push({commodity_type:"",quantity:1,site_id:""})},U=()=>{I.value=!I.value},T=i=>{if(!i.commodity_type||!i.site_id)return 0;const a=b.value.find(l=>l.site_id===i.site_id&&l.commodity_type===i.commodity_type);return a?a.available_quantity:0},R=i=>{if(!i.commodity_type||!i.site_id)return 0;const a=b.value.find(l=>l.site_id===i.site_id&&l.commodity_type===i.commodity_type);return a?a.available_quantity:0},L=i=>{const a=b.value.find(l=>l.site_id===i.site_id&&l.commodity_type===i.commodity_type);return a?a.available_quantity:0},O=i=>b.value.filter(a=>a.commodity_type===i).reduce((a,l)=>a+l.available_quantity,0),N=i=>b.value.filter(a=>a.site_name===i).reduce((a,l)=>a+l.available_quantity,0),Q=h(()=>{const i=new Set;return b.value.forEach(a=>{i.add(a.commodity_type)}),Array.from(i).sort()}),G=h(()=>{const i=new Map;return b.value.forEach(a=>{i.has(a.site_id)||i.set(a.site_id,{site_id:a.site_id,site_name:a.site_name})}),Array.from(i.values()).sort((a,l)=>a.site_name.localeCompare(l.site_name))});return{orderId:o,jobId:f,formData:s,availableCommodities:b,loading:A,error:S,submitting:D,isEditing:v,groupBy:E,showAvailableCommodities:I,groupedByCommodity:n,groupedBySite:c,availableCommodityTypes:Q,availableSites:G,loadJobData:F,addAvailableCommodity:B,removeCommodity:V,addEmptyCommodityRow:M,toggleAvailableCommodities:U,getMaxQuantity:L,getMaxQuantityForRow:T,getAvailableQuantityForRow:R,getTotalAvailableForCommodity:O,getTotalAvailableForSite:N,addAllCommoditiesOfType:i=>{b.value.filter(l=>l.commodity_type===i&&l.available_quantity>0).forEach(l=>{const g=s.value.commodities.findIndex(y=>y.commodity_type===l.commodity_type&&y.site_id===l.site_id);if(g===-1)s.value.commodities.push({commodity_type:l.commodity_type,quantity:l.available_quantity,site_id:l.site_id});else{const y=Math.max(s.value.commodities[g].quantity,l.available_quantity);s.value.commodities[g].quantity=y}})},addAllCommoditiesFromSite:i=>{b.value.filter(l=>l.site_name===i&&l.available_quantity>0).forEach(l=>{const g=s.value.commodities.findIndex(y=>y.commodity_type===l.commodity_type&&y.site_id===l.site_id);if(g===-1)s.value.commodities.push({commodity_type:l.commodity_type,quantity:l.available_quantity,site_id:l.site_id});else{const y=Math.max(s.value.commodities[g].quantity,l.available_quantity);s.value.commodities[g].quantity=y}})},goBack:()=>{v.value?e.push(`/order/${o.value}/jobs/${f.value}`):e.push(`/order/${o.value}`)},handleSubmit:async()=>{try{D.value=!0;const i=s.value.commodities.filter(l=>l.quantity>0&&Number.isInteger(l.quantity)&&l.commodity_type&&l.site_id);if(i.length===0){alert("Please add at least one commodity with a valid quantity (whole numbers only).");return}const a={job_type:s.value.job_type,external_job_id:s.value.external_job_id||null,contractor_fleet_carrier:s.value.contractor_fleet_carrier||null,subcontractor_jobId:s.value.subcontractor_jobId||null,job_cost:s.value.job_cost,due_date:s.value.due_date||null,commodities:i};if(v.value){const l=await k.updateJob(f.value,a);e.push(`/order/${o.value}/jobs/${l.job_id}`)}else{const l=await k.createJobFromOrder(o.value,a);e.push(`/order/${o.value}/jobs/${l.job_id}`)}}catch(i){console.error(`Error ${v.value?"updating":"creating"} job:`,i),alert(`Failed to ${v.value?"update":"create"} job. Please try again.`)}finally{D.value=!1}}}}},ot={class:"job-form"},at={class:"page-header"},it={class:"header-content"},st={class:"text-gray-600"},lt={class:"header-actions"},nt={class:"page-content"},rt={key:0,class:"loading"},dt={key:1,class:"error"},ut={class:"form-section"},ct={class:"form-grid-inline"},bt={key:0,class:"form-group-inline"},mt={class:"form-group-inline"},yt={key:0,class:"form-help"},_t={key:1,class:"form-group-inline"},vt={key:2,class:"form-group-inline"},pt={class:"form-grid-inline"},ft={class:"form-group-inline"},gt={class:"form-group-inline"},xt={class:"form-section"},ht={key:0,class:"no-commodities"},Ct={key:1},jt={class:"available-commodities mb-4"},kt={class:"flex justify-between items-center mb-4"},wt={class:"text-sm font-normal text-gray-500"},qt={key:0,class:"flex gap-2"},At={key:0,class:"transition-all duration-300"},St={key:0,class:"space-y-4"},Dt={class:"bg-gray-50 px-4 py-2 border-b flex justify-between items-center"},It={class:"font-medium text-gray-900"},Ft={class:"text-sm text-gray-600"},Et=["onClick","disabled"],Jt={class:"divide-y"},Bt={class:"font-medium"},Vt={class:"text-sm text-gray-600"},Mt={class:"flex items-center gap-4"},Ut={class:"text-right"},Tt={class:"font-semibold text-blue-600"},Rt=["onClick","disabled"],Lt={class:"space-y-4"},Ot={class:"bg-gray-50 px-4 py-2 border-b flex justify-between items-center"},Nt={class:"font-medium text-gray-900"},Qt={class:"text-sm text-gray-600"},Gt=["onClick","disabled"],Pt={class:"divide-y"},zt={class:"font-medium"},Ht={class:"text-sm text-gray-600"},Kt={class:"flex items-center gap-4"},Wt={class:"text-right"},Xt={class:"font-semibold text-blue-600"},Yt=["onClick","disabled"],Zt={class:"selected-commodities"},$t={class:"flex justify-between items-center mb-4"},te={key:0,class:"text-gray-500 text-center py-8 border-2 border-dashed border-gray-300 rounded-lg"},ee={key:1,class:"overflow-x-auto"},oe={class:"min-w-full border border-gray-200 rounded-lg overflow-hidden"},ae={class:"bg-white divide-y divide-gray-200"},ie={class:"px-4 py-3"},se=["onUpdate:modelValue"],le=["value"],ne={class:"px-4 py-3"},re=["onUpdate:modelValue"],de=["value"],ue={class:"px-4 py-3"},ce=["onUpdate:modelValue","max"],be={class:"px-4 py-3 text-sm text-gray-600"},me={class:"px-4 py-3 text-center"},ye=["onClick"],_e={class:"form-actions"},ve=["disabled"];function pe(q,e,k,o,f,v){return d(),r("div",ot,[t("div",at,[t("div",it,[t("h1",null,u(o.isEditing?"Edit Job":"Create New Job"),1),t("p",st,u(o.isEditing?`Edit job ${o.jobId} for order ${o.orderId}`:`Create a new job for order ${o.orderId}`),1)]),t("div",lt,[t("button",{class:"btn btn-secondary",onClick:e[0]||(e[0]=(...n)=>o.goBack&&o.goBack(...n))}," ← "+u(o.isEditing?"Back to Job":"Back to Order"),1)])]),t("div",nt,[o.loading?(d(),r("div",rt,e[13]||(e[13]=[t("p",null,"Loading job data...",-1)]))):o.error?(d(),r("div",dt,[t("p",null,u(o.error),1),t("button",{class:"btn btn-primary",onClick:e[1]||(e[1]=(...n)=>o.loadJobData&&o.loadJobData(...n))},"Retry")])):(d(),r("form",{key:2,onSubmit:e[12]||(e[12]=z((...n)=>o.handleSubmit&&o.handleSubmit(...n),["prevent"]))},[t("div",ut,[e[21]||(e[21]=t("h2",null,"Job Information",-1)),t("div",ct,[o.formData.job_type==="subcontractor"?(d(),r("div",bt,[e[14]||(e[14]=t("label",{for:"externalJobId"},"External Job ID:",-1)),m(t("input",{type:"text",id:"externalJobId","onUpdate:modelValue":e[2]||(e[2]=n=>o.formData.external_job_id=n),placeholder:"e.g., CMM-12345, FAC-789"},null,512),[[j,o.formData.external_job_id]])])):_("v-if",!0),t("div",mt,[e[16]||(e[16]=t("label",{for:"jobType"},"Job Type:",-1)),m(t("select",{id:"jobType","onUpdate:modelValue":e[3]||(e[3]=n=>o.formData.job_type=n),required:""},e[15]||(e[15]=[H('<option value="contractor" data-v-09b56548>Contractor (Internal)</option><option value="subcontractor" data-v-09b56548>Subcontractor (External)</option><option value="fac" data-v-09b56548>FAC</option><option value="gaia" data-v-09b56548>Gaia</option><option value="small batch" data-v-09b56548>Small Batch</option><option value="other" data-v-09b56548>Other</option>',6)]),512),[[w,o.formData.job_type]])])]),o.formData.job_type==="subcontractor"?(d(),r("p",yt," External Job ID from subcontractor system (CMM/Gaia, FAC, etc.). ")):_("v-if",!0),o.formData.job_type==="contractor"?(d(),r("div",_t,[e[17]||(e[17]=t("label",{for:"contractorFleetCarrier"},"Contractor Fleet/Carrier:",-1)),m(t("input",{type:"text",id:"contractorFleetCarrier","onUpdate:modelValue":e[4]||(e[4]=n=>o.formData.contractor_fleet_carrier=n),placeholder:"e.g., Fleet Alpha, Carrier Beta"},null,512),[[j,o.formData.contractor_fleet_carrier]])])):_("v-if",!0),o.formData.job_type==="subcontractor"?(d(),r("div",vt,[e[18]||(e[18]=t("label",{for:"subcontractorJobId"},"Subcontractor Job ID:",-1)),m(t("input",{type:"text",id:"subcontractorJobId","onUpdate:modelValue":e[5]||(e[5]=n=>o.formData.subcontractor_jobId=n),placeholder:"e.g., FAC-789, SPECIALIST-456"},null,512),[[j,o.formData.subcontractor_jobId]])])):_("v-if",!0),t("div",pt,[t("div",ft,[e[19]||(e[19]=t("label",{for:"jobCost"},"Job Cost:",-1)),m(t("input",{type:"number",id:"jobCost","onUpdate:modelValue":e[6]||(e[6]=n=>o.formData.job_cost=n),min:"0",step:"0.01",placeholder:"0.00"},null,512),[[j,o.formData.job_cost,void 0,{number:!0}]])]),t("div",gt,[e[20]||(e[20]=t("label",{for:"dueDate"},"Due Date:",-1)),m(t("input",{type:"date",id:"dueDate","onUpdate:modelValue":e[7]||(e[7]=n=>o.formData.due_date=n)},null,512),[[j,o.formData.due_date]])])])]),t("div",xt,[e[34]||(e[34]=t("h2",null,"Commodities",-1)),o.availableCommodities.length===0?(d(),r("div",ht,e[22]||(e[22]=[t("p",{class:"text-gray-600"}," No commodities available for allocation. All commodities may already be allocated to other jobs. ",-1)]))):(d(),r("div",Ct,[t("div",jt,[t("div",kt,[t("button",{type:"button",onClick:e[8]||(e[8]=(...n)=>o.toggleAvailableCommodities&&o.toggleAvailableCommodities(...n)),class:"flex items-center gap-2 text-lg font-medium text-gray-900 hover:text-blue-600 transition-colors"},[(d(),r("svg",{class:W(["w-5 h-5 transition-transform",{"rotate-90":o.showAvailableCommodities}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},e[23]||(e[23]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 5l7 7-7 7"},null,-1)]),2)),e[24]||(e[24]=K(" Available Commodities ")),t("span",wt," ("+u(o.availableCommodities.length)+" items) ",1)]),o.showAvailableCommodities?(d(),r("div",qt,[e[26]||(e[26]=t("label",{class:"text-sm text-gray-600"},"Group by:",-1)),m(t("select",{"onUpdate:modelValue":e[9]||(e[9]=n=>o.groupBy=n),class:"text-sm border rounded px-2 py-1"},e[25]||(e[25]=[t("option",{value:"commodity"},"Commodity",-1),t("option",{value:"site"},"Site",-1)]),512),[[w,o.groupBy]])])):_("v-if",!0)]),_(" Collapsible Content "),o.showAvailableCommodities?(d(),r("div",At,[_(" Commodity Grouped View "),o.groupBy==="commodity"?(d(),r("div",St,[(d(!0),r(p,null,x(o.groupedByCommodity,(n,c)=>(d(),r("div",{key:c,class:"border rounded-lg overflow-hidden"},[t("div",Dt,[t("div",null,[t("h4",It,u(c),1),t("p",Ft," Total available: "+u(o.getTotalAvailableForCommodity(c).toLocaleString()),1)]),t("button",{type:"button",class:"btn btn-sm btn-primary",onClick:s=>o.addAllCommoditiesOfType(c),disabled:o.getTotalAvailableForCommodity(c)<=0}," Add All ",8,Et)]),t("div",Jt,[(d(!0),r(p,null,x(n,s=>(d(),r("div",{key:`${s.site_id}-${s.commodity_type}`,class:"px-4 py-3 flex justify-between items-center hover:bg-gray-50"},[t("div",null,[t("div",Bt,u(s.site_name),1),t("div",Vt," Site ID: "+u(s.site_id),1)]),t("div",Mt,[t("div",Ut,[t("div",Tt,u(s.available_quantity.toLocaleString()),1),e[27]||(e[27]=t("div",{class:"text-xs text-gray-500"}," available ",-1))]),t("button",{type:"button",class:"btn btn-sm btn-primary",onClick:b=>o.addAvailableCommodity(s),disabled:s.available_quantity<=0}," Add ",8,Rt)])]))),128))])]))),128))])):(d(),r(p,{key:1},[_(" Site Grouped View "),t("div",Lt,[(d(!0),r(p,null,x(o.groupedBySite,(n,c)=>(d(),r("div",{key:c,class:"border rounded-lg overflow-hidden"},[t("div",Ot,[t("div",null,[t("h4",Nt,u(c),1),t("p",Qt,u(n.length)+" commodity type"+u(n.length!==1?"s":""),1)]),t("button",{type:"button",class:"btn btn-sm btn-primary",onClick:s=>o.addAllCommoditiesFromSite(c),disabled:o.getTotalAvailableForSite(c)<=0}," Add All ",8,Gt)]),t("div",Pt,[(d(!0),r(p,null,x(n,s=>(d(),r("div",{key:`${s.site_id}-${s.commodity_type}`,class:"px-4 py-3 flex justify-between items-center hover:bg-gray-50"},[t("div",null,[t("div",zt,u(s.commodity_type),1),t("div",Ht,u(s.available_quantity.toLocaleString())+" of "+u(s.total_quantity.toLocaleString())+" total ",1)]),t("div",Kt,[t("div",Wt,[t("div",Xt,u(s.available_quantity.toLocaleString()),1),e[28]||(e[28]=t("div",{class:"text-xs text-gray-500"}," available ",-1))]),t("button",{type:"button",class:"btn btn-sm btn-primary",onClick:b=>o.addAvailableCommodity(s),disabled:s.available_quantity<=0}," Add ",8,Yt)])]))),128))])]))),128))])],2112))])):_("v-if",!0)]),t("div",Zt,[t("div",$t,[e[29]||(e[29]=t("h3",{class:"text-lg font-medium text-gray-900"}," Selected Commodities ",-1)),t("button",{type:"button",class:"btn btn-sm btn-secondary",onClick:e[10]||(e[10]=(...n)=>o.addEmptyCommodityRow&&o.addEmptyCommodityRow(...n))}," + Add Commodity ")]),o.formData.commodities.length===0?(d(),r("div",te,e[30]||(e[30]=[t("p",null,"No commodities selected.",-1),t("p",{class:"text-sm"},' Use the "Add" buttons above or click "Add Commodity" to get started. ',-1)]))):(d(),r("div",ee,[t("table",oe,[e[33]||(e[33]=t("thead",{class:"bg-gray-50"},[t("tr",null,[t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Commodity "),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Site "),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Quantity "),t("th",{class:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"}," Available "),t("th",{class:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"}," Actions ")])],-1)),t("tbody",ae,[(d(!0),r(p,null,x(o.formData.commodities,(n,c)=>(d(),r("tr",{key:c,class:"hover:bg-gray-50"},[t("td",ie,[m(t("select",{"onUpdate:modelValue":s=>n.commodity_type=s,class:"w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:""},[e[31]||(e[31]=t("option",{value:""},"Select commodity...",-1)),(d(!0),r(p,null,x(o.availableCommodityTypes,s=>(d(),r("option",{key:s,value:s},u(s),9,le))),128))],8,se),[[w,n.commodity_type]])]),t("td",ne,[m(t("select",{"onUpdate:modelValue":s=>n.site_id=s,class:"w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",required:""},[e[32]||(e[32]=t("option",{value:""},"Select site...",-1)),(d(!0),r(p,null,x(o.availableSites,s=>(d(),r("option",{key:s.site_id,value:s.site_id},u(s.site_name),9,de))),128))],8,re),[[w,n.site_id]])]),t("td",ue,[m(t("input",{type:"number","onUpdate:modelValue":s=>n.quantity=s,class:"w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"0",min:"1",step:"1",max:o.getMaxQuantityForRow(n),required:""},null,8,ce),[[j,n.quantity,void 0,{number:!0}]])]),t("td",be,u(o.getAvailableQuantityForRow(n).toLocaleString()),1),t("td",me,[t("button",{type:"button",class:"btn btn-sm btn-danger",onClick:s=>o.removeCommodity(c)}," Remove ",8,ye)])]))),128))])])]))])]))]),t("div",_e,[t("button",{type:"submit",class:"btn btn-primary",disabled:o.submitting},u(o.submitting?"Saving...":o.isEditing?"Update Job":"Create Job"),9,ve),t("button",{type:"button",class:"btn btn-secondary",onClick:e[11]||(e[11]=(...n)=>o.goBack&&o.goBack(...n))},"Cancel")])],32))])])}const je=P(et,[["render",pe],["__scopeId","data-v-09b56548"],["__file","/app/src/js/components/JobForm.vue"]]);export{je as default};
